# issue #109: ensure that any 'ansible' module or package on the remote machine
# does not conflict with operation.

- hosts: all
  gather_facts: true
  become: true
  become_user: mitogen__user1
  tasks:
    - name: regression/issue_109__target_has_old_ansible_installed.yml
      assert:
        that: true

    # Copy the naughty 'ansible' into place.

    - copy:
        dest: "{{ansible_user_dir}}/ansible.py"
        src: ansible.py

    # Restart the connection.
    - mitogen_shutdown_all:

    - custom_python_detect_environment:
      register: env

    # Verify interpreter config would actually trigger the bug.
    - assert:
        that:
          - env.cwd == ansible_user_dir
          - env.python_path.count("") == 1

    # Run some new-style modules that 'from ansible.module_utils...'
    - stat:
        path: /
