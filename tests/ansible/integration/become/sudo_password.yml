# Verify passwordful sudo behaviour

- hosts: all
  any_errors_fatal: true
  tasks:
    - name: integration/become/sudo_password.yml
      assert:
        that: true

    - name: Ensure password sudo absent.
      shell: whoami
      become: true
      become_user: mitogen__pw_required
      register: out
      ignore_errors: true

    - assert:
        that: |
          out.failed and (
            ('password is required' in out.msg) or
            ('password is required' in out.module_stderr)
          )

    - name: Ensure password sudo incorrect.
      shell: whoami
      become: true
      become_user: mitogen__pw_required
      register: out
      vars:
        ansible_become_pass: nopes
      ignore_errors: true

    - assert:
        that: |
          out.failed and (
            ('Incorrect sudo password' in out.msg) or
            ('sudo password is incorrect' in out.msg)
          )

    - name: Ensure password sudo succeeds.
      shell: whoami
      become: true
      become_user: mitogen__pw_required
      register: out
      vars:
        ansible_become_pass: mitogen__password

    - assert:
        that:
          - out.stdout == 'mitogen__pw_required'
